[Usage - Page Impressions by SPWeb]
search = eventtype=mssharepoint-iis-page \
| lookup HostMapping host s_port OUTPUT Url \
| lookup SPWebApplication Url OUTPUT FarmId,Id as WebApplicationId \
| where isnotnull(WebApplicationId) \
| lookup SPIDS cs_uri_stem,WebApplicationId OUTPUT SiteId,WebId,ContentDatabaseId \
| rename WebId as Id \
| lookup SPWeb Id,FarmId OUTPUT Title \
| eval x=1 \
| timechart per_minute(x) by Title
dispatch.earliest_time = -24h
dispatch.latest_time = now
is_visible = false
disabled = false

[Usage - Unique Users by SPWeb]
search = eventtype=mssharepoint-iis-page \
| lookup HostMapping host s_port OUTPUT Url \
| lookup SPWebApplication Url OUTPUT FarmId,Id as WebApplicationId \
| where isnotnull(WebApplicationId) \
| lookup SPIDS cs_uri_stem,WebApplicationId OUTPUT SiteId,WebId,ContentDatabaseId \
| rename WebId as Id \
| lookup SPWeb Id,FarmId OUTPUT Title \
| timechart dc(cs_username) by Title
dispatch.earliest_time = -24h
dispatch.latest_time = now
is_visible = false
disabled = false

[Usage - Top Pages]
search = eventtype=mssharepoint-iis-page cs_username!="-" \
| lookup HostMapping host s_port OUTPUT Url \
| eval fullUrl = replace(Url + cs_uri_stem,"//","/") \
| top fullUrl \
| eval percent=round(percent,2) \
| rename fullUrl as "Page URL",count as "Page Impressions"
dispatch.earliest_time = -24h
dispatch.latest_time = now
is_visible = false
disabled = false

[Usage - Top Visitors]
search = eventtype=mssharepoint-iis-page cs_username!="-" \
| top cs_username \
| eval percent=round(percent,2) \
| rename cs_username as "Username",count as "Page Impressions"
dispatch.earliest_time = -24h
dispatch.latest_time = now
is_visible = false
disabled = false

[Usage - Top Browsers]
search = eventtype=mssharepoint-iis-page cs_username!="-" \
| lookup useragent cs_user_agent OUTPUT browser browserversion \
| eval cs_user_agent=replace(cs_user_agent,"\+"," ") \
| eval Browser=if(browser=="unknown",cs_user_agent, browser + " " + browserversion) \
| top Browser \
| eval percent=round(percent,2) \
| rename count as "Page Impressions"
dispatch.earliest_time = -24h
dispatch.latest_time = now
is_visible = false
disabled = false

[Usage - Most Active Sites by Uploads]
search = eventtype=mssharepoint-audit ItemType=1 Event=5 \
| lookup SPSite Id as SiteId OUTPUTNEW Url \
| top FarmId, Url \
| eval percent=round(percent,2)
dispatch.earliest_time = -24h
dispatch.latest_time = now
is_visible = false
disabled = false

[Usage - Most Active Sites by Downloads]
search = eventtype=mssharepoint-audit ItemType=1 Event=3 \
| lookup SPSite Id as SiteId OUTPUTNEW Url \
| top FarmId, Url \
| eval percent=round(percent,2)
dispatch.earliest_time = -24h
dispatch.latest_time = now
is_visible = false
disabled = false

[Usage - Dormant Sites]
search = | inputlookup SPSite \
| table Id, Url \
| rename Id as SiteId \
| join type=outer [ search eventtype=mssharepoint-audit Event<14 | stats count by SiteId ] \
| where isnull(count) \
| table SiteId,Url
dispatch.earliest_time = -7d
dispatch.latest_time = now
is_visible = false
disabled = false

[Usage - Read-Only Sites]
search = eventtype=mssharepoint-audit Event<14 \
| eval T=if(Event==1 OR Event==3,"read","write") \
| chart count by SiteId,T \
| where write==0 AND read>0 \
| lookup SPSite Id as SiteId OUTPUT Url \
| table SiteId, url
dispatch.earliest_time = -7d
dispatch.latest_time = now
is_visible = false
disabled = false

[Usage - Largest Sites by DB Size]
search = | inputlookup SPSite \
| stats max(Storage) as Storage by Id,Url \
| eval StorageMB=round(Storage/(1024*1024),2) \
| table Id,Url,StorageMB \
| sort -StorageMB \
| rename StorageMB AS "Size (MB)"
dispatch.earliest_time = -5m
dispatch.latest_time = now
is_visible = false
disabled = false

[Usage - Largest Sites by List Count]
search = eventtype=mssharepoint-inventory Type="List" \
| lookup SPWeb Id as WebId OUTPUT SiteId \
| stats dc(Id) as Lists by SiteId \
| lookup SPSite Id AS SiteId OUTPUT Url \
| table SiteId,Url,Lists|sort -Lists
dispatch.earliest_time = -24h
dispatch.latest_time = now
is_visible = false
disabled = false

[Lists - Top by Item Count]
search = eventtype=mssharepoint-inventory Type="List" Hidden="False" \
| stats latest(ItemCount) as ItemCount by Id,WebId,Title \
| lookup SPWeb Id as WebId OUTPUT Title as WebTitle \
| sort - ItemCount \
| table WebTitle, Title, ItemCount \
| rename WebTitle as "Web Title", Title as "List Title", ItemCount as "# Items"
dispatch.earliest_time = -24h
dispatch.latest_time = now
is_visible = false
disabled = false

[Lists - Top by Item Size]
search = eventtype=mssharepoint-inventory Type="List" Hidden="False" \
| stats latest(ItemSize) as ItemSize by Id,WebId,Title \
| lookup SPWeb Id as WebId OUTPUT Title as WebTitle \
| eval ItemSize = ItemSize / 1024 \
| eval ItemSize = round(ItemSize, 2) \
| sort - ItemSize \
| table WebTitle, Title, ItemSize \
| rename WebTitle as "Web Title", Title as "List Title", ItemSize as "Size (kb)"
dispatch.earliest_time = -24h
dispatch.latest_time = now
is_visible = false
disabled = false

[Lists - Empty]
search = eventtype=mssharepoint-inventory Type="List" Hidden="False" \
| stats latest(ItemCount) as ItemCount,latest(Created) as Created by Id,WebId,Title \
| lookup SPWeb Id as WebId OUTPUT Title as WebTitle \
| where ItemCount == 0 \
| table WebTitle, Title, Created \
| rename WebTitle as "Web Title", Title as "List Title"
dispatch.earliest_time = -24h
dispatch.latest_time = now
is_visible = false
disabled = false

[Lists - Most Updated]
search = eventtype=mssharepoint-inventory Type="List" Hidden="False" \
| stats max(Version) as maxVersion,min(Version) as minVersion by Id,WebId,Title \
| lookup SPWeb Id as WebId OUTPUT Title as WebTitle \
| eval Updates = maxVersion - minVersion \
| sort - Updates \
| table WebTitle, Title, Updates \
| rename WebTitle as "Web Title", Title as "List Title", Updates as "# Updates"
dispatch.earliest_time = -7d
dispatch.latest_time = now
is_visible = false
disabled = false

[Lists - Popular by Access Count]
search = eventtype=mssharepoint-audit ItemType=4 Event=3 \
| stats count by ItemId,FarmId \
| lookup SPList Id as ItemId OUTPUT WebId,Title \
| lookup SPWeb Id as WebId OUTPUT Title as WebTitle \
| table WebTitle, Title, count \
| sort - count \
| rename WebTitle as "Web Title", Title as "List Title",count as "# Accesses"
dispatch.earliest_time = -7d
dispatch.latest_time = now
is_visible = false
disabled = false

[Lists - Popular by Unique Users]
search = eventtype=mssharepoint-audit ItemType=4 Event=3 \
| stats dc(UserName) as count by ItemId,FarmId \
| lookup SPList Id as ItemId OUTPUT WebId,Title \
| lookup SPWeb Id as WebId OUTPUT Title as WebTitle \
| table WebTitle, Title, count \
| sort - count \
| rename WebTitle as "Web Title", Title as "List Title",count as "# Users"
dispatch.earliest_time = -7d
dispatch.latest_time = now
is_visible = false
disabled = false

[Documents - Most Read by Downloads]
search = eventtype=mssharepoint-audit ItemType=1 Event=3 \
| stats count by SiteId,DocLocation \
| lookup SPSite Id as SiteId OUTPUT Url \
| sort - count \
| table Url, DocLocation, count \
| rename count as "# Reads"
dispatch.earliest_time = -24h
dispatch.latest_time = now
is_visible = false
disabled = false

[Documents - Most Read by Distinct Users]
search = eventtype=mssharepoint-audit ItemType=1 Event=3 \
| stats dc(UserName) as count by SiteId,DocLocation \
| lookup SPSite Id as SiteId OUTPUT Url \
| sort - count \
| table Url, DocLocation, count \
| rename count as "# Users"
dispatch.earliest_time = -24h
dispatch.latest_time = now
is_visible = false
disabled = false

[Documents - Most Updated]
search = eventtype=mssharepoint-audit ItemType=1  (Event=2 OR Event=4 OR Event=5 OR Event=10 OR Event=14) \
| stats count by SiteId,DocLocation \
| lookup SPSite Id as SiteId OUTPUT Url \
| sort - count \
| table Url, DocLocation, count \
| rename count as "# Updates"
dispatch.earliest_time = -24h
dispatch.latest_time = now
is_visible = false
disabled = false

[Documents - Recently Deleted]
search = eventtype=mssharepoint-audit ItemType=1 Event=4 \
| lookup SPSite Id as SiteId OUTPUT Url \
| table _time, Url, DocLocation 
dispatch.earliest_time = -24h
dispatch.latest_time = now
is_visible = false
disabled = false

[Usage - Largest Sites as Percentage of Quota]
search = | inputlookup SPSite \
| search StorageMaximumLevel!=0 \
| eval QuotaUsed = (Storage / StorageMaximumLevel) * 100  \
| eval QuotaUsed = round(QuotaUsed,2) \
| table Url,QuotaUsed \
| sort - QuotaUsed \
| rename QuotaUsed as "Quota Used (%age)"
dispatch.earliest_time = -5m
dispatch.latest_time = now
is_visible = false
disabled = false

[Usage - Sites with Quota Issues]
search = | inputlookup SPSite \
| where StorageMaximumLevel==0 OR Storage>StorageWarningLevel \
| eval msg=case(StorageMaximumLevel==0,"No Quota Set",Storage>StorageWarningLevel,"Storage Approaching Quota") \
| table Url, Storage, msg \
| sort - Storage \
| rename Storage as "Disk Usage", msg as "Quota Issue"
dispatch.earliest_time = -5m
dispatch.latest_time - now
is_visible = false
disabled = false

