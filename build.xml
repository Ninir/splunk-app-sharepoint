<?xml version="1.0" encoding="UTF-8"?>
<project name="Splunk_for_Sharepoint">

 <!-- Directories that we need to operate -->
 <property name="vsprojects.dir" value="VSProjects"/>
 <property name="build.dir" value="build"/>
 <property name="build.version" value="0.1.0"/>
 
 <!-- Where we place the distribution file -->
 <property name="dist.file" value="${build.dir}/dist/${ant.project.name}.tar.gz"/>
 
 <!-- Various build directories for our apps -->
 <property name="mainapp.dir" value="${build.dir}/Splunk_for_Sharepoint"/>
 <property name="sp2010-addon.dir" value="${mainapp.dir}/appserver/addons/TA-Sharepoint2010"/>
 <property name="iis2008r2-addon.dir" value="${mainapp.dir}/appserver/addons/TA-Windows2008R2-IIS"/>
 <property name="sharepointaudit.src" value="${vsprojects.dir}/SharepointAudit"/>
 
 <!-- Compilation Directives for C#.NET -->
 <property name="csc.exe" value="C:\Windows\Microsoft.Net\Framework64\v4.0.30319\csc.exe"/>
 <property name="msbuild.exe" value="C:\Windows\Microsoft.Net\Framework64\v4.0.30319\msbuild.exe"/>
 <property name="vsconfig" value="Release"/>
 <property name="targetinfo" value="/p:Configuration=${vsconfig};Platform=x64;TargetFrameworkVersion=v3.5"/>
 
 <target name="clean">
  <delete dir="${build.dir}"/>
  <exec executable="${msbuild.exe}" dir="${sharepointaudit.src}">
   <arg value="/t:Clean"/>
   <arg value="${targetinfo}"/>
  </exec>
 </target>  

 <target name="mainapp">
  <mkdir dir="${mainapp.dir}"/>
  
  <!-- Copy the main files into the build area, replacing VERSION where possible -->
  <copy todir="${mainapp.dir}">
   <fileset dir="Splunk_for_Sharepoint">
    <exclude name="**/.*"/>
	<exclude name="local/**"/>
	<exclude name="**/*-gist"/>
	<exclude name="**/*.xcf"/>
	<exclude name="**/*.d/**"/>
   </fileset>
   <filterset>
    <filter token="VERSION" value="${build.version}"/>
   </filterset>
  </copy>
  
  <!-- Build the target configuration files -->
  <concat destfile="${mainapp.dir}/default/eventtypes.conf">
   <fileset dir="Splunk_for_Sharepoint/default/eventtypes.d" includes="*.conf"/>
  </concat>
  <echo>[concat] Created ${mainapp.dir}/default/eventtypes.conf</echo>
  
  <concat destfile="${mainapp.dir}/default/macros.conf">
   <fileset dir="Splunk_for_Sharepoint/default/macros.d" includes="*.conf"/>
  </concat>
  <echo>[concat] Created ${mainapp.dir}/default/macros.conf</echo>
  
  <concat destfile="${mainapp.dir}/default/props.conf">
   <fileset dir="Splunk_for_Sharepoint/default/props.d" includes="*.conf"/>
  </concat>
  <echo>[concat] Created ${mainapp.dir}/default/props.conf</echo>

  <concat destfile="${mainapp.dir}/default/transforms.conf">
   <fileset dir="Splunk_for_Sharepoint/default/transforms.d" includes="*.conf"/>
  </concat>
  <echo>[concat] Created ${mainapp.dir}/default/transforms.conf</echo>

  <concat destfile="${mainapp.dir}/default/savedsearches.conf">
   <fileset dir="Splunk_for_Sharepoint/default/savedsearches.d" includes="*.conf"/>
  </concat>
  <echo>[concat] Created ${mainapp.dir}/default/savedsearches.conf</echo>
  
 </target>
 
 <!-- Creates the sharepointaudit executable -->
 <target name="sharepointaudit">
	<exec executable="${msbuild.exe}" dir="${sharepointaudit.src}">
	 <arg value="${targetinfo}"/>
	</exec>
 </target>
 
 <!-- Creates the TA-Sharepoint2010 area -->
 <target name="sp2010-addon" depends="sharepointaudit">
  <mkdir dir="${sp2010-addon.dir}"/>
  
  <!-- Copy the main files into the build area, replacing VERSION where possible -->
  <copy todir="${sp2010-addon.dir}">
   <fileset dir="TA-Sharepoint2010"/>
   <filterset>
    <filter token="VERSION" value="${build.version}"/>
   </filterset>
  </copy>
  
  <!-- Copy the required files into the TA-Sharepoint2010 area -->
  <copy todir="${sp2010-addon.dir}/bin" file="${vsprojects.dir}/SplunkSDK.dll"/>
  <copy todir="${sp2010-addon.dir}/bin" file="${vsprojects.dir}/SharepointAudit/bin/${vsconfig}/SharepointAudit.exe"/>
  
 </target>
 
 <!-- Creates the TA-Windows2008R2-IIS area -->
 <target name="iis2008r2-addon">
  <mkdir dir="${iis2008r2-addon.dir}"/>
  
  <!-- Copy the main files into the build area, replacing VERSION where possible -->
  <copy todir="${iis2008r2-addon.dir}">
   <fileset dir="TA-Windows2008R2-IIS"/>
   <filterset>
    <filter token="VERSION" value="${build.version}"/>
   </filterset>
  </copy>
 </target>
 
 <!-- Packages the whole app together into something that can be uploaded to Splunkbase -->
 <target name="package" depends="mainapp,sp2010-addon,iis2008r2-addon">
  <mkdir dir="${build.dir}/dist"/>
  <tar destfile="${dist.file}" longfile="gnu" compression="gzip">
   <tarfileset dir="${build.dir}" filemode="755" username="splunk" group="splunk">
    <include name="Splunk_for_Sharepoint/**"/>
   </tarfileset>
  </tar>
 </target>

</project>
